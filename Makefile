SHELL:=/bin/bash

########################################################################################################################

IOT_UID:=$(shell python -c 'import sys, uuid; sys.stdout.write("%s" % uuid.uuid4())')

IOT_DESCR:=N/A

########################################################################################################################

CC=gcc
AR=ar
RANLIB=ranlib
CFLAGS=-std=c89 -fPIC -O3 -Dinline=__inline__ -Wall -Wextra -Wno-comment -Wno-unused-parameter `python3-config --includes` -DMQTTAsync_setConnectedCallback=MQTTAsync_setConnected -DIOT_UID=$(IOT_UID) -DIOT_DESCR=$(IOT_DESCR)

########################################################################################################################

export PKG_CONFIG_PATH:=$(PWD)/lib/pkgconfig

########################################################################################################################

all:
	mkdir -p bin
	mkdir -p lib

	####################################################################################################################
	# LIBBATKENS-IOT.A                                                                                                 #
	####################################################################################################################

	$(CC) $(CFLAGS) -c -o src/str.o src/str.c
	$(CC) $(CFLAGS) -c -o src/log.o src/log.c
	$(CC) $(CFLAGS) -c -o src/config.o src/config.c
	$(CC) $(CFLAGS) -c -o src/mqtt.o src/mqtt.c
	$(CC) $(CFLAGS) -c -o src/iot.o src/iot.c

	####################################################################################################################

	$(AR) rcs lib/libwombat-iot.a src/str.o src/log.o src/config.o src/mqtt.o src/iot.o && $(RANLIB) lib/libwombat-iot.a

	####################################################################################################################
	# BATKENS-IOT                                                                                                      #
	####################################################################################################################

	$(CC) $(CFLAGS) -o bin/wombat-iot src/wombat-iot.c -L lib -lwombat-iot -lpaho-mqtt3as `pkg-config python-3.7 --libs` `pkg-config openssl --libs` -lpthread

########################################################################################################################

deps:
	./scripts/make_dependencies.sh

########################################################################################################################

clean:
	rm -fr src/*.o lib/libbatkens-*.a bin/batkens-*

########################################################################################################################

.PHONY: plugins

########################################################################################################################
