SHELL:=/bin/bash

########################################################################################################################

PYTHON_LIBDIR:=$(shell python3 -c 'import sys, sysconfig; sys.stdout.write("%s" % sysconfig.get_config_var("LIBDIR"))')

########################################################################################################################

CC=gcc
AR=ar
RANLIB=ranlib

########################################################################################################################

CFLAGS=-std=c89 -O3 `python3-config --cflags` -Wall -Wextra -Wno-comment -Wno-unused-parameter -I include -Dinline=__inline__ -DMQTTAsync_setConnectedCallback=MQTTAsync_setConnected

########################################################################################################################

ifeq ($(shell uname -s),Darwin)
	LDFLAGS= -L lib `python3-config --ldflags` $(PYTHON_LIBDIR)/libpython*.dylib -L /opt/local/lib -lssl -lcrypto -pthread
else
	LDFLAGS= -L lib `python3-config --ldflags` -lssl -lcrypto -pthread
endif

########################################################################################################################

all:
	mkdir -p bin
	mkdir -p lib

	####################################################################################################################
	# LIBWOMBAT-IOT.A                                                                                                  #
	####################################################################################################################

	$(CC) $(CFLAGS) -c -o src/str.o src/str.c
	$(CC) $(CFLAGS) -c -o src/log.o src/log.c
	$(CC) $(CFLAGS) -c -o src/config.o src/config.c
	$(CC) $(CFLAGS) -c -o src/mqtt.o src/mqtt.c
	$(CC) $(CFLAGS) -c -o src/iot.o src/iot.c

	####################################################################################################################

	$(AR) rcs lib/libwombat-iot.a src/str.o src/log.o src/config.o src/mqtt.o src/iot.o && $(RANLIB) lib/libwombat-iot.a

	####################################################################################################################
	# WOMBAT-IOT                                                                                                       #
	####################################################################################################################

	$(CC) -o bin/wombat-iot src/wombat-iot.c -lwombat-iot -lpaho-mqtt3as $(LDFLAGS)

########################################################################################################################

deps:
	./scripts/make_dependencies.sh

########################################################################################################################

clean:
	rm -fr src/*.o lib/libwombat-iot.a bin/wombat-iot

########################################################################################################################

.PHONY: plugins

########################################################################################################################
